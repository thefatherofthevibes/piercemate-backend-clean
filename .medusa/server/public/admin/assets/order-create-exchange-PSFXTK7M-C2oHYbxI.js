import{I as Ae}from"./chunk-QJ6SBVJ2-518DPri1.js";import{g as Xe}from"./chunk-UC26CCHZ-DbXuoyCH.js";import{c as Ke,d as We,e as Ze,u as Ye,f as et,g as tt,h as st,i as nt,j as it,k as at,l as ot,m as rt,n as lt,o as dt,p as ct,q as ut}from"./chunk-3XBFXGEA-yFaohUEJ.js";import{R as mt,O as ht,C as pt}from"./chunk-P3DRE4IY-CYYWfAYb.js";import{g as Te,D as xt}from"./chunk-PXZ7QYKX-Q9Co3jcG.js";import{D as ft}from"./chunk-C7F7MMXS-BXIPDtJe.js";import{c as gt,o as _t}from"./chunk-43TDMTAG-DXGFzZwD.js";import{M as De}from"./chunk-INE2QCSC-9vPt_CRj.js";import{P as Re,a as qe}from"./chunk-IQBAUTU5-DpWPUSGG.js";import{a as te}from"./chunk-X6BAAGCL-Cmzs-01s.js";import{ag as bt,u as jt,b as G,de as yt,df as vt,r as v,j as e,t as O,dR as It,aC as Nt,aD as St,h as Et,H as xe,_ as ie,P as _e,dN as be,J as h,aF as je,ak as fe,d5 as Ct,B as se,ax as re,ay as ye,az as W,aI as ve,aK as Ie,dL as Pt,M as Oe,a3 as Q,dP as kt,s as we,dO as Mt,av as He,ds as Fe,K as pe,A as Le,a7 as Ne,dQ as At,a2 as ae,g as ze}from"./index-CU6eNUFN.js";import{u as Be,_ as Ve}from"./chunk-DTZXEQXZ-BaBmpiQu.js";import{C as oe}from"./chunk-OFN7DIZA-AqDsxLMm.js";import{c as Se}from"./chunk-DK4WIVY6-CYCbBMOO.js";import"./chunk-ZQJPHZKI-B-mOVF44.js";import{u as Ue}from"./chunk-C76H5USB-B0JL6HGS.js";import{K as Tt}from"./chunk-6HTZNHPT-CQK7Nsir.js";import{S as $}from"./chunk-WVA4O7QS-ClTyIHdU.js";import{R as K,u as Dt,a as Ge}from"./chunk-D6UW7URG-Dnreh06z.js";import{u as Rt}from"./chunk-HBXV7ENS-DMUVco03.js";import{X as $e}from"./x-circle-COKnXHGh.js";import{A as Qe}from"./alert-BeAS6yhq.js";import"./Trans-TuWeNclR.js";import"./chunk-P3UUX2T6-BbomILEi.js";import"./chunk-HQKGZADC-f8IAzGhQ.js";import"./chunk-EMIHDNB7-OmhvQEok.js";import"./chunk-DFFLVEZ5-D6yYebw6.js";import"./index-DA61-62J.js";var qt=re({inbound_items:ve(re({item_id:W(),quantity:Ie(),reason_id:W().nullish(),note:W().nullish()})),outbound_items:ve(re({item_id:W(),quantity:Ie()})),location_id:W().optional(),inbound_option_id:W().nullish(),outbound_option_id:W().nullish(),send_notification:ye().optional(),carry_over_promotions:ye().optional()}),ee=ze(),Ot=t=>{const{t:s}=G();return v.useMemo(()=>[ee.display({id:"select",header:({table:a})=>e.jsx(ae,{checked:a.getIsSomePageRowsSelected()?"indeterminate":a.getIsAllPageRowsSelected(),onCheckedChange:o=>a.toggleAllPageRowsSelected(!!o)}),cell:({row:a})=>{const o=a.getCanSelect();return e.jsx(ae,{disabled:!o,checked:a.getIsSelected(),onCheckedChange:n=>a.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}}),ee.display({id:"product",header:()=>e.jsx(qe,{}),cell:({row:a})=>e.jsx(Re,{product:{thumbnail:a.original.thumbnail,title:a.original.product_title}})}),ee.accessor("variant.sku",{header:s("fields.sku"),cell:({getValue:a})=>a()||"-"}),ee.accessor("variant.title",{header:s("fields.variant")}),ee.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:s("fields.quantity")})}),cell:({getValue:a,row:o})=>Te(o.original)}),ee.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:s("fields.price")})}),cell:({getValue:a})=>{const o=a()||0,n=te(o,t);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:n})})}})],[s,t])},wt=()=>{const{t}=G();return[{key:"created_at",label:t("fields.createdAt"),type:"date"},{key:"updated_at",label:t("fields.updatedAt"),type:"date"}]},Ht=({pageSize:t=50,prefix:s})=>{const a=Ue(["q","offset","order","created_at","updated_at"],s),{offset:o,created_at:n,updated_at:p,...b}=a;return{searchParams:{...b,limit:t,offset:o?Number(o):0,created_at:n?JSON.parse(n):void 0,updated_at:p?JSON.parse(p):void 0},raw:a}},le=50,Ee="rit",Ft=({onSelectionChange:t,selectedItems:s,items:a,currencyCode:o})=>{const{t:n}=G(),[p,b]=v.useState(s.reduce((j,I)=>(j[I]=!0,j),{})),P=j=>{const I=typeof j=="function"?j(p):j;b(I),t(Object.keys(I))},{searchParams:y,raw:M}=Ht({pageSize:le,prefix:Ee}),D=v.useMemo(()=>{const{order:j,offset:I,limit:L,q:E,created_at:z,updated_at:J}=y;let H=a;if(E&&(H=H.filter(U=>{var A;return U.product_title.toLowerCase().includes(E.toLowerCase())||U.variant_title.toLowerCase().includes(E.toLowerCase())||((A=U.variant_sku)==null?void 0:A.toLowerCase().includes(E.toLowerCase()))})),j){const U=j[0]==="-"?"desc":"asc",A=j.replace("-","");H=Lt(H,A,U)}return z&&(H=Ce(H,z,"created_at")),J&&(H=Ce(H,J,"updated_at")),H.slice(I,I+L)},[a,o,y]),T=Ot(o),F=wt(),{table:q}=Be({data:D,columns:T,count:D.length,enablePagination:!0,getRowId:j=>j.id,pageSize:le,enableRowSelection:j=>Te(j.original)>0,rowSelection:{state:p,updater:P}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ve,{table:q,columns:T,pageSize:le,count:D.length,filters:F,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:n("fields.product")},{key:"variant_title",label:n("fields.variant")},{key:"sku",label:n("fields.sku")}],prefix:Ee,queryObject:M})})},Lt=(t,s,a)=>t.sort((o,n)=>{let p,b;return s==="product_title"?(p=o.product_title,b=n.product_title):s==="variant_title"?(p=o.variant_title,b=n.variant_title):s==="sku"&&(p=o.variant_sku,b=n.variant_sku),p<b?a==="asc"?-1:1:p>b?a==="asc"?1:-1:0}),Ce=(t,s,a)=>{const{gt:o,gte:n,lt:p,lte:b}=s;return t.filter(P=>{const y=new Date(P[a]);let M=!0;return o&&(M=M&&y>new Date(o)),n&&(M=M&&y>=new Date(n)),p&&(M=M&&y<new Date(p)),b&&(M=M&&y<=new Date(b)),M})};function zt({item:t,previewItem:s,currencyCode:a,form:o,onRemove:n,onUpdate:p,index:b}){const{t:P}=G(),{return_reasons:y=[]}=Mt({fields:"+label"}),M=o.watch(`inbound_items.${b}`),D=typeof M.reason_id=="string",T=typeof M.note=="string",F=(s.adjustments||[]).map(q=>q.code);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-3 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(He,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-grow flex-col",children:[e.jsxs("div",{children:[e.jsxs(Q,{className:"txt-small",as:"span",weight:"plus",children:[t.title," "]}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(Q,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.product_title})]}),F.length>0&&e.jsx("div",{className:"flex flex-shrink",children:e.jsx(fe,{content:e.jsx("span",{className:"text-pretty",children:F.map(q=>e.jsx("div",{children:q},q))}),children:e.jsx(Fe,{className:"text-ui-fg-subtle"})})})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(h.Field,{control:o.control,name:`inbound_items.${b}.quantity`,render:({field:q})=>e.jsxs(h.Item,{children:[e.jsx(h.Control,{children:e.jsx(pe,{...q,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:t.quantity,type:"number",onBlur:j=>{const I=j.target.value,L=I===""?null:Number(I);q.onChange(L),L&&p({quantity:L})}})}),e.jsx(h.ErrorMessage,{})]})}),e.jsx(Q,{className:"txt-small text-ui-fg-subtle",children:P("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(De,{currencyCode:a,amount:s.return_requested_total})}),e.jsx(Le,{groups:[{actions:[!D&&{label:P("actions.addReason"),onClick:()=>o.setValue(`inbound_items.${b}.reason_id`,""),icon:e.jsx(pt,{})},!T&&{label:P("actions.addNote"),onClick:()=>o.setValue(`inbound_items.${b}.note`,""),icon:e.jsx(xt,{})},{label:P("actions.remove"),onClick:n,icon:e.jsx($e,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[D&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h.Label,{children:P("orders.returns.reason")}),e.jsx(h.Hint,{className:"!mt-1",children:P("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(h.Field,{control:o.control,name:`inbound_items.${b}.reason_id`,render:({field:{ref:q,value:j,onChange:I,...L}})=>e.jsxs(h.Item,{children:[e.jsx(h.Control,{children:e.jsx(oe,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:j,onChange:E=>{p({reason_id:E}),I(E)},...L,options:y.map(E=>({label:E.label,value:E.id}))})}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx(ie,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{o.setValue(`inbound_items.${b}.reason_id`,null),p({reason_id:null})},children:e.jsx(Ne,{className:"text-ui-fg-muted"})})]})]}),T&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h.Label,{children:P("orders.returns.note")}),e.jsx(h.Hint,{className:"!mt-1",children:P("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(h.Field,{control:o.control,name:`inbound_items.${b}.note`,render:({field:{ref:q,...j}})=>e.jsxs(h.Item,{children:[e.jsx(h.Control,{children:e.jsx(pe,{...j,onBlur:()=>{j.onChange(j.value),p({internal_note:j.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx(ie,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{o.setValue(`inbound_items.${b}.note`,null),p({internal_note:null})},children:e.jsx(Ne,{className:"text-ui-fg-muted"})})]})]})]})]})}var de=[],Pe=[],Bt=({order:t,preview:s,exchange:a,form:o,orderReturn:n})=>{var R;const{t:p}=G(),{setIsOpen:b}=Ge(),[P,y]=v.useState({}),{mutateAsync:M}=_t((R=s==null?void 0:s.order_change)==null?void 0:R.return_id,t.id),{mutateAsync:D}=st(a.id,t.id),{mutateAsync:T}=nt(a.id,t.id),{mutateAsync:F}=it(a.id,t.id),{mutateAsync:q}=at(a.id,t.id),{mutateAsync:j}=ot(a.id,t.id),I=v.useMemo(()=>{var r;return(r=s==null?void 0:s.items)==null?void 0:r.filter(c=>{var m;return!!((m=c.actions)!=null&&m.find(x=>x.exchange_id===a.id))})},[s.items]),L=I.filter(r=>{var c;return!!((c=r.actions)!=null&&c.find(m=>m.action==="RETURN_ITEM"))}),E=v.useMemo(()=>{var r;return new Map((r=t==null?void 0:t.items)==null?void 0:r.map(c=>[c.id,c]))},[t.items]),z=o.watch("location_id"),{stock_locations:J=[]}=Pt({limit:999}),{shipping_options:H=[]}=Rt({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:z},{enabled:!!z}),U=H.filter(r=>!!r.rules.find(c=>c.attribute==="is_return"&&c.value==="true")),{fields:A,append:Z,remove:Y,update:B}=Oe({name:"inbound_items",control:o.control}),V=v.useMemo(()=>new Map(I.map(r=>[r.id,r])),[I,A]);v.useEffect(()=>{const r={};L.forEach(c=>{var x,k;const m=A.findIndex(N=>N.item_id===c.id);if(r[c.id]=!0,m>-1){if(A[m].quantity!==c.detail.return_requested_quantity){const N=(x=c.actions)==null?void 0:x.find(i=>i.action==="RETURN_ITEM");B(m,{...A[m],quantity:c.detail.return_requested_quantity,note:N==null?void 0:N.internal_note,reason_id:(k=N==null?void 0:N.details)==null?void 0:k.reason_id})}}else Z({item_id:c.id,quantity:c.detail.return_requested_quantity},{shouldFocus:!1})}),A.forEach((c,m)=>{c.item_id in r||Y(m)})},[I]),v.useEffect(()=>{const r=s.shipping_methods.find(c=>{var m;return(m=c.actions)==null?void 0:m.find(x=>x.action==="SHIPPING_ADD"&&!!x.return_id)});r?o.setValue("inbound_option_id",r.shipping_option_id):o.setValue("inbound_option_id","")},[s.shipping_methods]),v.useEffect(()=>{o.setValue("location_id",n==null?void 0:n.location_id)},[n]);const _=!A.length,u=async()=>{var r,c,m;de.length&&await F({items:de.map(x=>({id:x,quantity:1}))},{onError:x=>{O.error(x.message)}});for(const x of Pe){const k=(m=(c=(r=I.find(N=>N.id===x))==null?void 0:r.actions)==null?void 0:c.find(N=>N.action==="RETURN_ITEM"))==null?void 0:m.id;k&&await j(k,{onError:N=>{O.error(N.message)}})}b("inbound-items",!1)},d=async r=>{await M({location_id:r})},g=async r=>{const m=s.shipping_methods.filter(x=>{var k;return(k=x.actions)==null?void 0:k.find(N=>N.action==="SHIPPING_ADD"&&!!N.return_id)}).filter(Boolean).map(x=>{var N;const k=(N=x.actions)==null?void 0:N.find(i=>i.action==="SHIPPING_ADD"&&!!i.return_id);if(k)return T(k.id)});await Promise.all(m),r&&await D({shipping_option_id:r},{onError:x=>{O.error(x.message)}})},C=v.useMemo(()=>z?!A.map(c=>{var x,k;const m=E.get(c.item_id);return!(m!=null&&m.variant_id)||!(m!=null&&m.variant)||!((x=m.variant)!=null&&x.manage_inventory)?!0:(k=P[m.variant_id])==null?void 0:k.find(N=>N.location_id===z)}).every(Boolean):!1,[A,P,z]);return v.useEffect(()=>{(async()=>{const c={};if(!A.length)return c;const m=A.map(k=>k==null?void 0:k.variant_id).filter(Boolean);return(await we.admin.productVariant.list({id:m,fields:"*inventory.location_levels"})).variants.forEach(k=>{var N,i;c[k.id]=((i=(N=k.inventory)==null?void 0:N[0])==null?void 0:i.location_levels)||[]}),c})().then(c=>{y(c)})},[A]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(xe,{level:"h2",children:p("orders.returns.inbound")}),e.jsxs($,{id:"inbound-items",children:[e.jsx($.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:p("actions.addItems")})}),e.jsxs($.Content,{children:[e.jsx($.Header,{}),e.jsx(Ft,{items:t.items,selectedItems:A.map(r=>r.item_id),currencyCode:t.currency_code,onSelectionChange:r=>{const c=A.map(m=>m.item_id);de=r.filter(m=>!c.includes(m)),Pe=c.filter(m=>!r.includes(m))}}),e.jsx($.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(K.Close,{asChild:!0,children:e.jsx(se,{type:"button",variant:"secondary",size:"small",children:p("actions.cancel")})}),e.jsx(se,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await u(),children:p("actions.save")},"submit-button")]})})})]})]})]}),_&&e.jsx(Ae,{}),A.map((r,c)=>V.get(r.item_id)&&E.get(r.item_id)&&e.jsx(zt,{item:E.get(r.item_id),previewItem:V.get(r.item_id),currencyCode:t.currency_code,form:o,onRemove:()=>{var x,k,N;const m=(N=(k=(x=I.find(i=>i.id===r.item_id))==null?void 0:x.actions)==null?void 0:k.find(i=>i.action==="RETURN_ITEM"))==null?void 0:N.id;m&&j(m,{onError:i=>{O.error(i.message)}})},onUpdate:m=>{var k,N;const x=(N=(k=I.find(i=>i.id===r.item_id))==null?void 0:k.actions)==null?void 0:N.find(i=>i.action==="RETURN_ITEM");x&&q({...m,actionId:x.id},{onError:i=>{var f,l;(f=x.details)!=null&&f.quantity&&m.quantity&&o.setValue(`inbound_items.${c}.quantity`,(l=x.details)==null?void 0:l.quantity),O.error(i.message)}})},index:c},r.id)),!_&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h.Label,{children:p("orders.returns.location")}),e.jsx(h.Hint,{className:"!mt-1",children:p("orders.returns.locationHint")})]}),e.jsx(h.Field,{control:o.control,name:"location_id",render:({field:{value:r,onChange:c,...m}})=>e.jsx(h.Item,{children:e.jsx(h.Control,{children:e.jsx(oe,{...m,value:r??void 0,onChange:x=>{c(x),d(x)},options:(J??[]).map(x=>({label:x.name,value:x.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(h.Label,{children:[p("orders.returns.inboundShipping"),e.jsxs(Q,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",p("fields.optional"),")"]})]}),e.jsx(h.Hint,{className:"!mt-1",children:p("orders.returns.inboundShippingHint")})]}),e.jsx(h.Field,{control:o.control,name:"inbound_option_id",render:({field:{value:r,onChange:c,...m}})=>e.jsx(h.Item,{children:e.jsx(h.Control,{children:e.jsx(oe,{allowClear:!0,value:r??void 0,onChange:x=>{c(x),g(x)},...m,options:U.map(x=>({label:x.name,value:x.id})),disabled:!z,noResultsPlaceholder:e.jsx(mt,{})})})})})]})]}),C&&e.jsxs(Qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:p("orders.returns.noInventoryLevel")}),e.jsx(Q,{className:"text-ui-fg-subtle txt-small leading-normal",children:p("orders.returns.noInventoryLevelDesc")})]})]})},ne=ze(),Vt=t=>{const{t:s}=G();return v.useMemo(()=>[ne.display({id:"select",header:({table:a})=>e.jsx(ae,{checked:a.getIsSomePageRowsSelected()?"indeterminate":a.getIsAllPageRowsSelected(),onCheckedChange:o=>a.toggleAllPageRowsSelected(!!o)}),cell:({row:a})=>{const o=a.getCanSelect();return e.jsx(ae,{disabled:!o,checked:a.getIsSelected(),onCheckedChange:n=>a.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}}),ne.display({id:"product",header:()=>e.jsx(qe,{}),cell:({row:a})=>e.jsx(Re,{product:a.original.product})}),ne.accessor("sku",{header:s("fields.sku"),cell:({getValue:a})=>a()||"-"}),ne.accessor("title",{header:s("fields.title")})],[s,t])},Ut=()=>{const{t}=G();return[{key:"created_at",label:t("fields.createdAt"),type:"date"},{key:"updated_at",label:t("fields.updatedAt"),type:"date"}]},Gt=({pageSize:t=50,prefix:s})=>{const a=Ue(["q","offset","order","created_at","updated_at"],s),{offset:o,created_at:n,updated_at:p,...b}=a;return{searchParams:{...b,limit:t,offset:o?Number(o):0,created_at:n?JSON.parse(n):void 0,updated_at:p?JSON.parse(p):void 0},raw:a}},ce=50,ke="rit",$t=({onSelectionChange:t,selectedItems:s,currencyCode:a})=>{const{t:o}=G(),[n,p]=v.useState(s.reduce((j,I)=>(j[I]=!0,j),{})),b=j=>{const I=typeof j=="function"?j(n):j;p(I),t(Object.keys(I))},{searchParams:P,raw:y}=Gt({pageSize:ce,prefix:ke}),{variants:M=[],count:D}=At({...P,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),T=Vt(a),F=Ut(),{table:q}=Be({data:M,columns:T,count:D,enablePagination:!0,getRowId:j=>j.id,pageSize:ce,enableRowSelection:j=>!0,rowSelection:{state:n,updater:b}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ve,{table:q,columns:T,pageSize:ce,count:D,filters:F,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:o("fields.product")},{key:"title",label:o("fields.title")},{key:"sku",label:o("fields.sku")}],prefix:ke,queryObject:y})})};function Qt({previewItem:t,currencyCode:s,form:a,onRemove:o,onUpdate:n,index:p}){const{t:b}=G(),P=(t.adjustments||[]).map(y=>y.code);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-3 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(He,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-grow flex-col",children:[e.jsxs("div",{children:[e.jsxs(Q,{className:"txt-small",as:"span",weight:"plus",children:[t.title," "]}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(Q,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.subtitle})]}),P.length>0&&e.jsx("div",{className:"flex flex-shrink",children:e.jsx(fe,{content:e.jsx("span",{className:"text-pretty",children:P.map(y=>e.jsx("div",{children:y},y))}),children:e.jsx(Fe,{className:"text-ui-fg-subtle"})})})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(h.Field,{control:a.control,name:`outbound_items.${p}.quantity`,render:({field:y})=>e.jsxs(h.Item,{children:[e.jsx(h.Control,{children:e.jsx(pe,{...y,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:M=>{const D=M.target.value,T=D===""?null:Number(D);y.onChange(T),T&&n({quantity:T})}})}),e.jsx(h.ErrorMessage,{})]})}),e.jsx(Q,{className:"txt-small text-ui-fg-subtle",children:b("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(De,{currencyCode:s,amount:t.total})}),e.jsx(Le,{groups:[{actions:[{label:b("actions.remove"),onClick:o,icon:e.jsx($e,{})}].filter(Boolean)}]})]})]})})}var ue=[],Me=[],Jt=({order:t,preview:s,exchange:a,form:o})=>{const{t:n}=G(),{setIsOpen:p}=Ge(),[b,P]=v.useState({}),{shipping_options:y=[]}=kt(t.id),M=y.filter(_=>{var u;return!((u=_.rules)!=null&&u.find(d=>d.attribute==="is_return"&&d.value==="true"))}),{mutateAsync:D}=rt(a.id,t.id),{mutateAsync:T}=lt(a.id,t.id),{mutateAsync:F}=dt(a.id,t.id),{mutateAsync:q}=ct(a.id,t.id),{mutateAsync:j}=ut(a.id,t.id),I=v.useMemo(()=>{var _;return(_=s==null?void 0:s.items)==null?void 0:_.filter(u=>{var d;return!!((d=u.actions)!=null&&d.find(g=>g.exchange_id===a.id&&g.action==="ITEM_ADD"))})},[s.items]),L=v.useMemo(()=>{var _;return new Map((_=t==null?void 0:t.items)==null?void 0:_.map(u=>[u.variant_id,u]))},[t.items]),{fields:E,append:z,remove:J,update:H}=Oe({name:"outbound_items",control:o.control}),U=v.useMemo(()=>new Map(I.map(_=>[_.variant_id,_])),[I,E]);v.useEffect(()=>{const _={};I.forEach(u=>{const d=E.findIndex(g=>g.item_id===u.id);_[u.id]=!0,d>-1?E[d].quantity!==u.detail.quantity&&H(d,{...E[d],quantity:u.detail.quantity}):z({item_id:u.id,quantity:u.detail.quantity,variant_id:u.variant_id},{shouldFocus:!1})}),E.forEach((u,d)=>{u.item_id in _||J(d)})},[I]);const A=o.watch("location_id"),Z=!E.length,Y=async()=>{var _,u;ue.length&&await F({items:ue.map(d=>({variant_id:d,quantity:1}))},{onError:d=>{O.error(d.message)}});for(const d of Me){const g=(u=(_=I.find(C=>C.variant_id===d))==null?void 0:_.actions)==null?void 0:u.find(C=>C.action==="ITEM_ADD");g!=null&&g.id&&await j(g==null?void 0:g.id,{onError:C=>{O.error(C.message)}})}p("outbound-items",!1)};v.useEffect(()=>{const _=s.shipping_methods.find(u=>{var d;return!!((d=u.actions)!=null&&d.find(g=>g.action==="SHIPPING_ADD"&&!g.return_id))});_?o.setValue("outbound_option_id",_.shipping_option_id):o.setValue("outbound_option_id","")},[s.shipping_methods]);const B=async _=>{const d=s.shipping_methods.filter(g=>{var C;return!!((C=g.actions)!=null&&C.find(R=>R.action==="SHIPPING_ADD"&&!R.return_id))}).filter(Boolean).map(g=>{var R;const C=(R=g.actions)==null?void 0:R.find(r=>r.action==="SHIPPING_ADD"&&!r.return_id);if(C)return T(C.id)});await Promise.all(d),_&&await D({shipping_option_id:_},{onError:g=>{O.error(g.message)}})},V=v.useMemo(()=>A?!E.map(u=>{var g,C;const d=L.get(u.variant_id);return!(d!=null&&d.variant_id)||!(d!=null&&d.variant)||!((g=d.variant)!=null&&g.manage_inventory)?!0:(C=b[d.variant_id])==null?void 0:C.find(R=>R.location_id===A)}).every(Boolean):!1,[E,b,A]);return v.useEffect(()=>{(async()=>{const u={};if(!E.length)return u;const d=E.map(C=>C==null?void 0:C.variant_id).filter(Boolean);return(await we.admin.productVariant.list({id:d,fields:"*inventory.location_levels"})).variants.forEach(C=>{var R,r;u[C.id]=((r=(R=C.inventory)==null?void 0:R[0])==null?void 0:r.location_levels)||[]}),u})().then(u=>{P(u)})},[E]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(xe,{level:"h2",children:n("orders.returns.outbound")}),e.jsxs($,{id:"outbound-items",children:[e.jsx($.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:n("actions.addItems")})}),e.jsxs($.Content,{children:[e.jsx($.Header,{}),e.jsx($t,{selectedItems:E.map(_=>_.variant_id),currencyCode:t.currency_code,onSelectionChange:_=>{const u=E.map(d=>d.variant_id);ue=_.filter(d=>!u.includes(d)),Me=u.filter(d=>!_.includes(d))}}),e.jsx($.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(K.Close,{asChild:!0,children:e.jsx(se,{type:"button",variant:"secondary",size:"small",children:n("actions.cancel")})}),e.jsx(se,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await Y(),children:n("actions.save")},"submit-button")]})})})]})]})]}),Z&&e.jsx(Ae,{}),E.map((_,u)=>U.get(_.variant_id)&&e.jsx(Qt,{previewItem:U.get(_.variant_id),currencyCode:t.currency_code,form:o,onRemove:()=>{var g,C,R;const d=(R=(C=(g=I.find(r=>r.id===_.item_id))==null?void 0:g.actions)==null?void 0:C.find(r=>r.action==="ITEM_ADD"))==null?void 0:R.id;d&&j(d,{onError:r=>{O.error(r.message)}})},onUpdate:d=>{var C,R,r;const g=(r=(R=(C=I.find(c=>c.id===_.item_id))==null?void 0:C.actions)==null?void 0:R.find(c=>c.action==="ITEM_ADD"))==null?void 0:r.id;g&&q({...d,actionId:g},{onError:c=>{O.error(c.message)}})},index:u},_.id)),!Z&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h.Label,{children:n("orders.exchanges.outboundShipping")}),e.jsx(h.Hint,{className:"!mt-1",children:n("orders.exchanges.outboundShippingHint")})]}),e.jsx(h.Field,{control:o.control,name:"outbound_option_id",render:({field:{value:_,onChange:u,...d}})=>e.jsx(h.Item,{children:e.jsx(h.Control,{children:e.jsx(oe,{allowClear:!0,noResultsPlaceholder:e.jsx(ht,{}),value:_??void 0,onChange:g=>{u(g),B(g)},...d,options:M.map(g=>({label:`${g.name} (${Xe(g)})`,value:g.id})),disabled:!M.length})})})})]})}),V&&e.jsxs(Qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:n("orders.returns.noInventoryLevel")}),e.jsx(Q,{className:"text-ui-fg-subtle txt-small leading-normal",children:n("orders.returns.noInventoryLevelDesc")})]})]})},me=!1,Xt=({order:t,preview:s,exchange:a,orderReturn:o})=>{var N;const{t:n}=G(),{handleSuccess:p}=Dt(),[b,P]=v.useState(!1),[y,M]=v.useState(!1),[D,T]=v.useState({value:"0",float:0}),[F,q]=v.useState({value:"0",float:0}),{mutateAsync:j,isPending:I}=Ze(a.id,t.id),{mutateAsync:L,isPending:E}=Ye(a.id,t.id),{mutateAsync:z,isPending:J}=et(a.id,t.id),{mutateAsync:H,isPending:U}=tt(a.id,t.id),{mutateAsync:A}=It((N=s==null?void 0:s.order_change)==null?void 0:N.id,{onError:i=>{O.error(i.message)}}),Z=I||E||U||J,Y=v.useMemo(()=>{var i;return(i=s==null?void 0:s.items)==null?void 0:i.filter(f=>{var l;return!!((l=f.actions)!=null&&l.find(S=>S.exchange_id===a.id))})},[s.items]),B=Y.filter(i=>{var f;return!!((f=i.actions)!=null&&f.find(l=>l.action==="RETURN_ITEM"))}),V=Y.filter(i=>{var f;return!!((f=i.actions)!=null&&f.find(l=>l.action==="ITEM_ADD"))}),_=v.useMemo(()=>t.promotions&&Array.isArray(t.promotions)&&t.promotions.length>0,[t]),u=Nt({defaultValues:()=>{var l;const i=s.shipping_methods.find(S=>{var w;return!!((w=S.actions)!=null&&w.find(X=>X.action==="SHIPPING_ADD"&&!!X.return_id))}),f=s.shipping_methods.find(S=>{var w;return!!((w=S.actions)!=null&&w.find(X=>X.action==="SHIPPING_ADD"&&!X.return_id))});return Promise.resolve({inbound_items:B.map(S=>{var X,ge;const w=(X=S.actions)==null?void 0:X.find(Je=>Je.action==="RETURN_ITEM");return{item_id:S.id,variant_id:S.variant_id,quantity:S.detail.return_requested_quantity,note:w==null?void 0:w.internal_note,reason_id:(ge=w==null?void 0:w.details)==null?void 0:ge.reason_id}}),outbound_items:V.map(S=>({item_id:S.id,variant_id:S.variant_id,quantity:S.detail.quantity})),inbound_option_id:i?i.shipping_option_id:"",outbound_option_id:f?f.shipping_option_id:"",location_id:o==null?void 0:o.location_id,send_notification:!1,carry_over_promotions:((l=s==null?void 0:s.order_change)==null?void 0:l.carry_over_promotions)??!1})},resolver:St(qt)}),d=s.shipping_methods.find(i=>{var f;return!!((f=i.actions)!=null&&f.find(l=>l.action==="SHIPPING_ADD"&&!!l.return_id))}),g=s.shipping_methods.find(i=>{var f;return!!((f=i.actions)!=null&&f.find(l=>l.action==="SHIPPING_ADD"&&!l.return_id))});v.useEffect(()=>{d&&T(d.total)},[d]),v.useEffect(()=>{g&&q(g.total)},[g]);const C=u.watch("inbound_option_id"),R=u.watch("outbound_option_id"),r=Et(),c=u.handleSubmit(async i=>{try{if(!await r({title:n("general.areYouSure"),description:n("orders.exchanges.confirmText"),confirmText:n("actions.continue"),cancelText:n("actions.cancel"),variant:"confirmation"}))return;await j({no_notification:!i.send_notification}),p()}catch(f){O.error(n("general.error"),{description:f.message})}});v.useEffect(()=>{var i;b&&((i=document.getElementById("js-inbound-shipping-input"))==null||i.focus())},[b]),v.useEffect(()=>{var i;y&&((i=document.getElementById("js-outbound-shipping-input"))==null||i.focus())},[y]),v.useEffect(()=>()=>{me&&(L(void 0,{onSuccess:()=>{O.success(n("orders.exchanges.actions.cancelExchange.successToast"))},onError:i=>{O.error(i.message)}}),me=!1)},[]);const m=s.summary.pending_difference-B.reduce((i,f)=>i+f.total,0),x=v.useMemo(()=>{const i=s.shipping_methods.find(f=>{var l;return!!((l=f.actions)!=null&&l.find(S=>S.action==="SHIPPING_ADD"&&!!S.return_id))});return(i==null?void 0:i.total)||0},[s.shipping_methods]),k=v.useMemo(()=>{const i=s.shipping_methods.find(f=>{var l;return!!((l=f.actions)!=null&&l.find(S=>S.action==="SHIPPING_ADD"&&!S.return_id))});return(i==null?void 0:i.total)||0},[s.shipping_methods]);return e.jsx(K.Form,{form:u,children:e.jsxs(Tt,{onSubmit:c,className:"flex h-full flex-col",children:[e.jsx(K.Header,{}),e.jsx(K.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(xe,{level:"h1",children:n("orders.exchanges.create")}),e.jsx(Bt,{form:u,preview:s,order:t,exchange:a,orderReturn:o}),e.jsx(Jt,{form:u,preview:s,order:t,exchange:a}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:n("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:te(B.reduce((i,f)=>{var S;const l=(S=f.actions)==null?void 0:S.find(w=>w.action==="RETURN_ITEM");return i=i+((l==null?void 0:l.details.quantity)||0)/f.quantity*f.total,i},0)*-1,t.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:n("orders.exchanges.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:te(V.reduce((i,f)=>(i=i+(f.total||0),i),0),t.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:n("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!b&&e.jsx(ie,{onClick:()=>P(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(B!=null&&B.length)||!C,children:e.jsx(_e,{})}),b?e.jsx(be,{id:"js-inbound-shipping-input",onBlur:()=>{let i;s.shipping_methods.forEach(l=>{if(l.actions)for(const S of l.actions)S.action==="SHIPPING_ADD"&&S.return_id&&(i=S.id)});const f=D.float;i&&z({actionId:i,custom_amount:f},{onError:l=>{O.error(l.message)}}),P(!1)},symbol:Se[t.currency_code.toUpperCase()].symbol_native,code:t.currency_code,onValueChange:(i,f,l)=>T({value:(l==null?void 0:l.value)??"",float:(l==null?void 0:l.float)??null}),value:D.value,disabled:!(B!=null&&B.length)}):te(x,t.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:n("orders.exchanges.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!y&&e.jsx(ie,{onClick:()=>M(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(V!=null&&V.length)||!R,children:e.jsx(_e,{})}),y?e.jsx(be,{id:"js-outbound-shipping-input",onBlur:()=>{let i;s.shipping_methods.forEach(l=>{if(l.actions)for(const S of l.actions)S.action==="SHIPPING_ADD"&&!S.return_id&&(i=S.id)});const f=F.float;i&&H({actionId:i,custom_amount:f},{onError:l=>{O.error(l.message)}}),M(!1)},symbol:Se[t.currency_code.toUpperCase()].symbol_native,code:t.currency_code,onValueChange:(i,f,l)=>q({value:(l==null?void 0:l.value)??"",float:(l==null?void 0:l.float)??null}),value:F.value,disabled:!(V!=null&&V.length)}):te(k,t.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:n("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:te(m,t.currency_code)})]})]}),_&&e.jsx("div",{className:"bg-ui-bg-field mt-4 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(h.Field,{control:u.control,name:"carry_over_promotions",render:({field:{onChange:i,value:f,...l}})=>e.jsxs(h.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h.Control,{className:"mr-4 self-start",children:e.jsx(je,{dir:"ltr",className:"mt-[2px] rtl:rotate-180",checked:!!f,onCheckedChange:async S=>{var w;i(S),(w=s==null?void 0:s.order_change)!=null&&w.id&&await A({carry_over_promotions:S})},...l})}),e.jsxs("div",{className:"block",children:[e.jsxs(h.Label,{className:"flex items-center gap-x-2",children:[n("orders.exchanges.carryOverPromotion"),e.jsx(h.Hint,{children:e.jsx(fe,{content:n("orders.exchanges.carryOverPromotionTooltip"),children:e.jsx(Ct,{})})})]}),e.jsx(h.Hint,{className:"!mt-1",children:n("orders.exchanges.carryOverPromotionHint")})]})]}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(h.Field,{control:u.control,name:"send_notification",render:({field:{onChange:i,value:f,...l}})=>e.jsxs(h.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h.Control,{className:"mr-4 self-start",children:e.jsx(je,{dir:"ltr",className:"mt-[2px] rtl:rotate-180",checked:!!f,onCheckedChange:i,...l})}),e.jsxs("div",{className:"block",children:[e.jsx(h.Label,{children:n("orders.returns.sendNotification")}),e.jsx(h.Hint,{className:"!mt-1",children:n("orders.returns.sendNotificationHint")})]})]}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(K.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(K.Close,{asChild:!0,children:e.jsx(se,{type:"button",onClick:()=>me=!0,variant:"secondary",size:"small",children:n("orders.exchanges.cancel.title")})}),e.jsx(se,{type:"submit",variant:"primary",size:"small",isLoading:Z,children:n("orders.exchanges.confirm")},"submit-button")]})})})]})})},he=!1,Ns=()=>{const{id:t}=bt(),s=jt(),{t:a}=G(),{order:o}=yt(t,{fields:ft}),{order:n}=vt(t),[p,b]=v.useState(),{mutateAsync:P}=Ke(o.id),{exchange:y}=We(p,void 0,{enabled:!!p}),{return:M}=gt(y==null?void 0:y.return_id,void 0,{enabled:!!(y!=null&&y.return_id)});return v.useEffect(()=>{async function D(){if(!(he||!n)){if(n.order_change){n.order_change.change_type==="exchange"?b(n.order_change.exchange_id):(s(`/orders/${n.id}`,{replace:!0}),O.error(a("orders.exchanges.activeChangeError")));return}he=!0;try{const{exchange:T}=await P({order_id:n.id});b(T.id)}catch(T){O.error(T.message),s(`/orders/${n.id}`,{replace:!0})}finally{he=!1}}}D()},[n]),e.jsx(K,{children:y&&n&&o&&e.jsx(Xt,{order:o,exchange:y,preview:n,orderReturn:M})})};export{Ns as Component};
