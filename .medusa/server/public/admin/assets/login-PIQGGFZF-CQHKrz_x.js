import{A as I}from"./chunk-O333RR6K-nklcswjn.js";import{b as g,c as U,u as F,a as $,gx as z,aC as B,aD as H,gy as R,fb as W,j as e,H as D,a3 as O,J as i,K as A,a1 as K,B as P,L as V,ax as q,az as L,au as J,r as S,gz as M,bh as G,t as T,s as x}from"./index-CU6eNUFN.js";import{l as Q}from"./index.modern-DEACsmk-.js";import{T as X}from"./Trans-TuWeNclR.js";import{A as Y}from"./alert-BeAS6yhq.js";import"./chunk-KIIT4BNH-C4Q4cLxR.js";var f="cloud",Z=()=>{const{t:a}=g(),[o]=J(),{handleCallback:c,isCallbackPending:l}=ee(o),n=o.get("auth_provider")===f&&o.has("code")&&o.has("state"),u=S.useRef(!1);S.useEffect(()=>{n&&!u.current&&(u.current=!0,c())},[n,c]);const s=async()=>{try{const t=await x.auth.login("user",f,{callback_url:`${window.location.origin}${window.location.pathname}?auth_provider=${f}`});if(typeof t=="object"&&t.location){window.location.href=t.location;return}throw new Error("Unexpected login response")}catch{T.error(a("auth.login.authenticationFailed"))}};return e.jsxs(e.Fragment,{children:[e.jsx("hr",{className:"bg-ui-border-base my-4"}),e.jsx(P,{variant:"secondary",onClick:s,className:"w-full",disabled:l,isLoading:l,children:a("auth.login.cloud")})]})},ee=a=>{const{t:o}=g(),c=F(),{mutateAsync:l}=M(),{mutateAsync:n,isPending:u}=G({mutationFn:async()=>{let s;try{const m=Object.fromEntries(a);delete m.auth_provider,s=await x.auth.callback("user",f,m)}catch{throw new Error("Authentication callback failed")}const t=Q(s);if(!(t!=null&&t.actor_id)&&(await l(),!await x.auth.refresh({Authorization:`Bearer ${s}`})))throw new Error("Failed to refresh token after user creation");return!0},onSuccess:()=>{c("/")},onError:()=>{T.error(o("auth.login.authenticationFailed"))}});return{handleCallback:n,isCallbackPending:u}},se=q({email:L().email(),password:L()}),le=()=>{var v,w,y,E,C,N,k;const{t:a}=g(),o=U(),c=F(),{getWidgets:l}=$(),{data:n}=z(),u=((w=(v=o.state)==null?void 0:v.from)==null?void 0:w.pathname)||"/orders",s=B({resolver:H(se),defaultValues:{email:"",password:""}}),{mutateAsync:t,isPending:m}=R(),_=s.handleSubmit(async({email:r,password:d})=>{await t({email:r,password:d},{onError:h=>{if(W(h)&&h.status===401){s.setError("email",{type:"manual",message:h.message});return}s.setError("root.serverError",{type:"manual",message:h.message})},onSuccess:()=>{c(u,{replace:!0})}})}),p=(C=(E=(y=s.formState.errors)==null?void 0:y.root)==null?void 0:E.serverError)==null?void 0:C.message,b=((N=s.formState.errors.email)==null?void 0:N.message)||((k=s.formState.errors.password)==null?void 0:k.message),j=[...l("login.after")];return n!=null&&n.enabled&&j.push(Z),e.jsx("div",{className:"bg-ui-bg-subtle flex min-h-dvh w-dvw items-center justify-center",children:e.jsxs("div",{className:"m-4 flex w-full max-w-[280px] flex-col items-center",children:[e.jsx(I,{}),e.jsxs("div",{className:"mb-4 flex flex-col items-center",children:[e.jsx(D,{children:a("login.title")}),e.jsx(O,{size:"small",className:"text-ui-fg-subtle text-center",children:a("login.hint")})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[l("login.before").map((r,d)=>e.jsx(r,{},d)),e.jsx(i,{...s,children:e.jsxs("form",{onSubmit:_,className:"flex w-full flex-col gap-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-y-1",children:[e.jsx(i.Field,{control:s.control,name:"email",render:({field:r})=>e.jsx(i.Item,{children:e.jsx(i.Control,{children:e.jsx(A,{autoComplete:"email",...r,className:"bg-ui-bg-field-component",placeholder:a("fields.email")})})})}),e.jsx(i.Field,{control:s.control,name:"password",render:({field:r})=>e.jsxs(i.Item,{children:[e.jsx(i.Label,{}),e.jsx(i.Control,{children:e.jsx(A,{type:"password",autoComplete:"current-password",...r,className:"bg-ui-bg-field-component",placeholder:a("fields.password")})})]})})]}),b&&e.jsx("div",{className:"text-center",children:e.jsx(K,{className:"inline-flex",variant:"error",children:b})}),p&&e.jsx(Y,{className:"bg-ui-bg-base items-center p-2",dismissible:!0,variant:"error",children:p}),e.jsx(P,{className:"w-full",type:"submit",isLoading:m,children:a("actions.continueWithEmail")})]})}),j.map((r,d)=>e.jsx(r,{},d))]}),e.jsx("span",{className:"text-ui-fg-muted txt-small my-6",children:e.jsx(X,{i18nKey:"login.forgotPassword",components:[e.jsx(V,{to:"/reset-password",className:"text-ui-fg-interactive transition-fg hover:text-ui-fg-interactive-hover focus-visible:text-ui-fg-interactive-hover font-medium outline-none"},"reset-password-link")]})})]})})};export{le as Component};
