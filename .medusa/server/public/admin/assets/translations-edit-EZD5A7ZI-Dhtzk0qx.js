import{D as _,a as je}from"./chunk-FKNW5MLZ-BSlHOqUq.js";import{K as ye}from"./chunk-6HTZNHPT-CQK7Nsir.js";import"./chunk-WVA4O7QS-ClTyIHdU.js";import{R as T,u as ve}from"./chunk-D6UW7URG-Dnreh06z.js";import{d as Se,u as _e,au as be,r as c,gt as Ee,gv as Re,v as Te,j as t,k as Ne,b as ae,aC as Pe,aD as ze,gw as De,t as B,aw as V,B as k,c$ as R,ax as oe,aH as le,a3 as L,az as se}from"./index-CU6eNUFN.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./textarea-zAje8BFr.js";var Me=oe({id:se().nullish(),fields:le(se().optional())}),Ve=oe({entities:le(Me)});function I(a){return a._type==="entity"}function ne(a,o,d,l){var h;const n=new Map;for(const e of a)e.locale_code===d&&n.set(e.reference_id,e);const u={};for(const e of o){const s=n.get(e.id),i={};for(const m of l)i[m]=((h=s==null?void 0:s.translations)==null?void 0:h[m])??"";u[e.id]={id:(s==null?void 0:s.id)??null,fields:i}}return{localeCode:d,entities:u}}function ke(a,o,d,l){var h;const n=new Map;for(const e of o)e.locale_code===a.localeCode&&n.set(e.reference_id,e);const u={...a.entities};for(const e of d)if(!u[e.id]){const s=n.get(e.id),i={};for(const m of l)i[m]=((h=s==null?void 0:s.translations)==null?void 0:h[m])??"";u[e.id]={id:(s==null?void 0:s.id)??null,fields:i}}return{...a,entities:u}}function re(a){return{entities:a.entities}}function ie(a,o,d,l){const n={create:[],update:[],delete:[]};for(const[h,e]of Object.entries(a.entities)){const s=o.entities[h];if(!s)continue;const i=Object.values(e.fields).some(x=>x!==void 0&&x.trim()!==""),m=Object.values(s.fields).some(x=>x!==void 0&&x.trim()!==""),N=JSON.stringify(e.fields)!==JSON.stringify(s.fields);!e.id&&i?n.create.push({reference_id:h,reference:d,locale_code:l,translations:e.fields}):e.id&&i&&N?n.update.push({id:e.id,translations:e.fields}):e.id&&!i&&m&&n.delete.push(e.id)}return{hasChanges:n.create.length>0||n.update.length>0||n.delete.length>0,payload:n}}var q=je(),ce=350;function Ie(a,o){return a.map(d=>({_type:"entity",reference_id:d.id,subRows:o.map(l=>({_type:"field",reference_id:d.id,field_name:l}))}))}function Fe({entities:a,availableLocales:o,selectedLocale:d,dynamicColumnWidth:l}){const{t:n}=ae();return c.useMemo(()=>{const u=o.find(e=>e.locale_code===d),h=[q.column({id:"field",name:"field",size:ce,header:void 0,cell:e=>{const s=e.row.original;return I(s)?t.jsx(_.ReadonlyCell,{context:e}):t.jsx(_.ReadonlyCell,{context:e,color:"normal",children:t.jsx("div",{className:"flex h-full w-full items-center gap-x-2 overflow-hidden",children:t.jsx(L,{className:"text-ui-fg-subtle truncate",weight:"plus",size:"small",children:n(`fields.${s.field_name}`,{defaultValue:s.field_name})})})})},disableHiding:!0}),q.column({id:"original",name:"original",size:l,header:()=>t.jsx(L,{className:"text-ui-fg-base",weight:"plus",size:"small",children:n("general.original")}),disableHiding:!0,cell:e=>{const s=e.row.original;if(I(s))return t.jsx(_.ReadonlyCell,{context:e});const i=a.find(m=>m.id===s.reference_id);return i?t.jsx(_.ReadonlyCell,{color:"normal",context:e,isMultiLine:!0,children:t.jsx(L,{className:"text-ui-fg-subtle",weight:"plus",size:"small",children:i[s.field_name]})}):null}})];return u&&h.push(q.column({id:u.locale_code,name:u.locale.name,size:l,header:()=>t.jsx(L,{className:"text-ui-fg-base",weight:"plus",size:"small",children:u.locale.name}),cell:e=>{const s=e.row.original;return I(s)?t.jsx(_.ReadonlyCell,{context:e,isMultiLine:!0}):t.jsx(_.MultilineCell,{context:e})},field:e=>{const s=e.row.original;return I(s)?null:`entities.${s.reference_id}.fields.${s.field_name}`},type:"multiline-text"})),h},[n,o,d,a,l])}var He=({translations:a,references:o,entityType:d,availableLocales:l,translatableFields:n,fetchNextPage:u,hasNextPage:h,isFetchingNextPage:e,referenceCount:s})=>{var ee;const{t:i}=ae(),{handleSuccess:m,setCloseOnEscape:N}=ve(),x=c.useRef(null),[W,$]=c.useState(400);c.useEffect(()=>{const r=()=>{if(x.current){const j=x.current.offsetWidth-ce-16,p=Math.max(300,Math.floor(j/2));$(p)}};r();const g=new ResizeObserver(r);return x.current&&g.observe(x.current),()=>g.disconnect()},[]);const[w,G]=c.useState(((ee=l[0])==null?void 0:ee.locale_code)??""),[U,v]=c.useState(!1),[P,z]=c.useState(null),[Z,F]=c.useState(!1),y=c.useRef(ne(a,o,w,n)),J=c.useRef(new Set(o.map(r=>r.id))),Q=c.useRef({translations:a,references:o});c.useEffect(()=>{Q.current={translations:a,references:o}},[a,o]);const C=Pe({resolver:ze(Ve),defaultValues:re(y.current)});c.useEffect(()=>{const r=new Set(o.map(p=>p.id)),g=o.filter(p=>!J.current.has(p.id));if(g.length===0)return;J.current=r,y.current=ke(y.current,a,g,n);const j={entities:{...C.getValues().entities}};for(const p of g)j.entities[p.id]||(j.entities[p.id]=y.current.entities[p.id]);C.reset(j,{keepDirty:!0,keepDirtyValues:!0})},[o,a,n,C]);const de=c.useMemo(()=>Ie(o,n),[o,n]),ue=c.useMemo(()=>s*(n.length+1),[s,n]),fe=c.useMemo(()=>{var r;return(r=l.find(g=>g.locale_code===w))==null?void 0:r.locale.name},[l,w]),he=Fe({entities:o,availableLocales:l,selectedLocale:w,dynamicColumnWidth:W}),{mutateAsync:X,isPending:me,invalidateQueries:H}=De(d),O=c.useCallback(async()=>{const r=C.getValues(),{hasChanges:g,payload:f}=ie(r,y.current,d,w);if(!g)return!0;try{const p=f.create.length+f.update.length+f.delete.length,we=Math.ceil(p/150);for(let b=0;b<we;b++){let M=150;const E={create:[],update:[],delete:[]};f.create.length>0&&(E.create=f.create.splice(0,M),M-=E.create.length),f.update.length>0&&(E.update=f.update.splice(0,M),M-=E.update.length),f.delete.length>0&&(E.delete=f.delete.splice(0,M));const te=await X(E,{onError:S=>{B.error(S.message)}});if(te.created)for(const S of te.created)C.setValue(`entities.${S.reference_id}.id`,S.id,{shouldDirty:!1}),y.current.entities[S.reference_id]&&(y.current.entities[S.reference_id].id=S.id)}const K=C.getValues();for(const b of Object.keys(K.entities))y.current.entities[b]&&(y.current.entities[b]={...K.entities[b]});return C.reset(K),!0}catch(j){return B.error(j instanceof Error?j.message:"Failed to save translations"),!1}},[C,d,w,X]),A=c.useCallback(async r=>{F(!0);try{await H(),await new Promise(p=>requestAnimationFrame(p));const{translations:g,references:f}=Q.current,j=ne(g,f,r,n);y.current=j,J.current=new Set(f.map(p=>p.id)),C.reset(re(j)),G(r)}finally{F(!1)}},[n,C,H]),ge=c.useCallback(r=>{if(r===w)return;const g=C.getValues(),{hasChanges:f}=ie(g,y.current,d,w);f?(z(r),v(!0)):A(r)},[w,C,d,A]),pe=c.useCallback(async()=>{await O()&&P&&(B.success(i("translations.edit.successToast")),await A(P)),v(!1),z(null)},[O,P,i,A]),Ce=c.useCallback(()=>{v(!1),z(null)},[]),Y=c.useCallback(async(r=!1)=>{await O()&&(B.success(i("translations.edit.successToast")),r&&m())},[O,i,m]),xe=c.useCallback(()=>{H()},[H]),D=me||Z;return t.jsxs(T.Form,{form:C,onClose:xe,children:[t.jsxs(ye,{onSubmit:()=>Y(!0),className:"flex h-full flex-col overflow-hidden",children:[t.jsx(T.Header,{}),t.jsx(T.Body,{className:"size-full overflow-hidden",children:t.jsx("div",{ref:x,className:"size-full",children:t.jsx(_,{showColumnsDropdown:!1,columns:he,data:de,getSubRows:r=>{if(I(r))return r.subRows},state:C,onEditingChange:r=>N(!r),totalRowCount:ue,onFetchMore:u,isFetchingMore:e,hasNextPage:h,headerContent:t.jsxs(V,{disabled:D,value:w,onValueChange:ge,size:"small",children:[t.jsx(V.Trigger,{className:"bg-ui-bg-base w-[200px]",children:t.jsx(V.Value,{children:fe})}),t.jsx(V.Content,{children:l.map(r=>t.jsx(V.Item,{value:r.locale_code,children:r.locale.name},r.locale_code))})]})})})}),t.jsx(T.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[t.jsx(T.Close,{asChild:!0,children:t.jsx(k,{type:"button",size:"small",variant:"secondary",isLoading:D,children:i("actions.cancel")})}),t.jsx(k,{size:"small",type:"button",variant:"secondary",onClick:()=>Y(!1),isLoading:D,children:i("actions.saveChanges")}),t.jsx(k,{size:"small",type:"submit",isLoading:D,children:i("actions.saveAndClose")})]})})]}),t.jsx(R,{open:U,variant:"confirmation",children:t.jsxs(R.Content,{children:[t.jsxs(R.Header,{children:[t.jsx(R.Title,{children:i("translations.edit.unsavedChanges.title")}),t.jsx(R.Description,{children:i("translations.edit.unsavedChanges.description")})]}),t.jsxs(R.Footer,{children:[t.jsx(k,{size:"small",variant:"secondary",onClick:Ce,type:"button",children:i("actions.close")}),t.jsx(k,{size:"small",onClick:pe,type:"button",isLoading:D,children:i("actions.saveChanges")})]})]})})]})},Ue=()=>{const a=Se("translation"),o=_e(),[d]=be(),l=d.get("reference"),n=d.getAll("reference_id");c.useEffect(()=>{if(!l||!a){o(-1);return}},[l,o,a]);const{translatable_fields:u,isPending:h,isError:e,error:s}=Ee({entity_type:l}),{translations:i,references:m,fetchNextPage:N,count:x,isFetchingNextPage:W,hasNextPage:$,isPending:w,isError:G,error:U}=Re(l,n,{enabled:!!l,placeholderData:Ne}),{store:v,isPending:P,isError:z,error:Z}=Te(),F=!w&&!!i&&!!u&&!h&&!!m&&!P&&!!v;if(G||z||e)throw U||Z||s;return t.jsx(T,{prev:n.length?-1:"..",children:F&&t.jsx(He,{translations:i,references:m,entityType:l,availableLocales:(v==null?void 0:v.supported_locales)??[],translatableFields:u[l],fetchNextPage:N,hasNextPage:$,isFetchingNextPage:W,referenceCount:x})})};export{Ue as Component};
