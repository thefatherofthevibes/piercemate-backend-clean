import{P as ae}from"./chunk-KFYQTOGB-Deo9QDZ_.js";import{u as le,P as oe,a as ne,b as ce}from"./chunk-5ISRTMYH-BRfSQQur.js";import{j as e,r as R,b as A,z as Y,aC as de,aD as ue,er as pe,t as $,B as E,ax as K,aI as ee,az as I,e2 as X,aA as q,M as me,H as xe,a3 as J,J as t,K as he,aw as _,I as D,bM as Q,c9 as fe,_ as ge,$ as je,a0 as be,F as O,f as se,k as ve,a2 as W,g as ye}from"./index-CU6eNUFN.js";import{e as Pe,i as Ce}from"./chunk-G2J2T2QU-BxhIgft4.js";import{u as Se}from"./chunk-BW322BVH-DE0UiVzz.js";import{u as Le,_ as _e}from"./chunk-DTZXEQXZ-BaBmpiQu.js";import{D as we}from"./chunk-FKNW5MLZ-BSlHOqUq.js";import{u as Ne,a as Te}from"./chunk-R65S6ZZV-B_GxI6mj.js";import"./chunk-ZQJPHZKI-B-mOVF44.js";import{K as Fe}from"./chunk-6HTZNHPT-CQK7Nsir.js";import{S as F}from"./chunk-WVA4O7QS-ClTyIHdU.js";import{R as w,u as te,a as Ie}from"./chunk-D6UW7URG-Dnreh06z.js";import{P as y}from"./progress-tabs-tcfMUrUN.js";import{R as V}from"./radio-group-DJBI5ron.js";import{T as Re}from"./textarea-zAje8BFr.js";import"./chunk-ZJRFL6ZN-DCw5YWMh.js";import"./chunk-C76H5USB-B0JL6HGS.js";import"./chunk-MSDRGCRR-CofsaNWy.js";import"./chunk-P3UUX2T6-BbomILEi.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-XLDQPLK4-D0NBFajW.js";import"./chunk-ADOCJB6L-Dv-zw8lO.js";import"./chunk-IQBAUTU5-DpWPUSGG.js";import"./chunk-HQKGZADC-f8IAzGhQ.js";import"./chunk-EMIHDNB7-OmhvQEok.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./chunk-DFFLVEZ5-D6yYebw6.js";import"./index-DA61-62J.js";var ke=({form:i})=>{const{t:s}=A(),n=Y(),{fields:l,remove:g,append:j}=me({control:i.control,name:"rules.customer_group_id",keyName:"cg_id"}),{setIsOpen:p}=Ie(),f=o=>{const x=o.map(h=>h.id),c=o.filter(h=>!l.some(C=>C.id===h.id));for(const h of l)x.includes(h.id)||g(l.indexOf(h));j(c),p("cg",!1)};return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-8 py-16",children:[e.jsxs("div",{children:[e.jsx(xe,{children:s("priceLists.create.header")}),e.jsx(J,{size:"small",className:"text-ui-fg-subtle",children:s("priceLists.create.subheader")})]}),e.jsx(t.Field,{control:i.control,name:"type",render:({field:{onChange:o,...x}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{children:[e.jsx(t.Label,{children:s("priceLists.fields.type.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.type.hint")})]}),e.jsx(t.Control,{children:e.jsxs(V,{dir:n,onValueChange:o,...x,className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(V.ChoiceBox,{value:"sale",label:s("priceLists.fields.type.options.sale.label"),description:s("priceLists.fields.type.options.sale.description")}),e.jsx(V.ChoiceBox,{value:"override",label:s("priceLists.fields.type.options.override.label"),description:s("priceLists.fields.type.options.override.description")})]})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1  gap-4 md:grid-cols-2",children:[e.jsx(t.Field,{control:i.control,name:"title",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.title")}),e.jsx(t.Control,{children:e.jsx(he,{...o})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:i.control,name:"status",render:({field:{onChange:o,ref:x,...c}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("priceLists.fields.status.label")}),e.jsx(t.Control,{children:e.jsxs(_,{dir:n,...c,onValueChange:o,children:[e.jsx(_.Trigger,{ref:x,children:e.jsx(_.Value,{})}),e.jsxs(_.Content,{children:[e.jsx(_.Item,{value:"active",children:s("priceLists.fields.status.options.active")}),e.jsx(_.Item,{value:"draft",children:s("priceLists.fields.status.options.draft")})]})]})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(t.Field,{control:i.control,name:"description",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.description")}),e.jsx(t.Control,{children:e.jsx(Re,{...o})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(D,{}),e.jsx(t.Field,{control:i.control,name:"starts_at",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.startsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.startsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(Q,{granularity:"minute",shouldCloseOnSelect:!1,...o})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(D,{}),e.jsx(t.Field,{control:i.control,name:"ends_at",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.endsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.endsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(Q,{granularity:"minute",shouldCloseOnSelect:!1,...o})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(D,{}),e.jsx(t.Field,{control:i.control,name:"rules.customer_group_id",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.customerAvailability.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.customerAvailability.hint")})]}),e.jsx(t.Control,{children:e.jsxs("div",{className:be("bg-ui-bg-component shadow-elevation-card-rest transition-fg grid gap-1.5 rounded-xl py-1.5","aria-[invalid='true']:shadow-borders-error"),role:"application",ref:o.ref,children:[e.jsxs("div",{className:"text-ui-fg-subtle grid gap-1.5 px-1.5 md:grid-cols-2",children:[e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("priceLists.fields.customerAvailability.attribute")}),e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("operators.in")})]}),e.jsx("div",{className:"flex items-center gap-1.5 px-1.5",children:e.jsxs(F,{id:"cg",children:[e.jsx(F.Trigger,{asChild:!0,children:e.jsxs("button",{type:"button",className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover shadow-borders-base txt-compact-small text-ui-fg-muted transition-fg focus-visible:shadow-borders-interactive-with-active flex flex-1 items-center gap-x-2 rounded-md px-2 py-1.5 outline-none",children:[e.jsx(fe,{}),s("priceLists.fields.customerAvailability.placeholder")]})}),e.jsx(F.Trigger,{asChild:!0,children:e.jsx(E,{variant:"secondary",children:s("actions.browse")})}),e.jsxs(F.Content,{children:[e.jsx(F.Header,{}),e.jsx(ae,{state:l,setState:f,type:"focus"})]})]})}),l.length>0?e.jsxs("div",{className:"flex flex-col gap-y-1.5",children:[e.jsx(D,{variant:"dashed"}),e.jsx("div",{className:"flex flex-col gap-y-1.5 px-1.5",children:l.map((x,c)=>e.jsxs("div",{className:"bg-ui-bg-field-component shadow-borders-base flex items-center justify-between gap-2 rounded-md px-2 py-0.5",children:[e.jsx(J,{size:"small",leading:"compact",children:x.name}),e.jsx(ge,{size:"small",variant:"transparent",type:"button",onClick:()=>g(c),children:e.jsx(je,{})})]},x.cg_id))})]}):null]})}),e.jsx(t.ErrorMessage,{})]})})]})})},De=({form:i,currencies:s,regions:n,pricePreferences:l})=>{const g=O({control:i.control,name:"product_ids"}),j=O({control:i.control,name:"products"}),{products:p,isLoading:f,isError:o,error:x}=se({id:g.map(m=>m.id),limit:g.length,fields:"title,thumbnail,*variants,-type,-collection,-options,-tags,-images,-sales_channels"}),{setCloseOnEscape:c}=te(),{setValue:h}=i;R.useEffect(()=>{!f&&p&&p.forEach(m=>{j[m.id]||!m.variants||h(`products.${m.id}.variants`,{...m.variants.reduce((S,N)=>(S[N.id]={currency_prices:{},region_prices:{}},S),{})})})},[p,j,f,h]);const C=ce({currencies:s,regions:n,pricePreferences:l});if(o)throw x;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(we,{isLoading:f,columns:C,data:p,getSubRows:m=>{if(Ce(m)&&m.variants)return m.variants},state:i,onEditingChange:m=>c(!m)})})},B=50,G="p";function Ee(i){return i.reduce((s,n)=>(s[n.id]=!0,s),{})}var Oe=({form:i})=>{const{t:s}=A(),{control:n,setValue:l}=i,g=O({control:n,name:"product_ids"}),j=O({control:n,name:"products"}),[p,f]=R.useState(Ee(g)),{searchParams:o,raw:x}=Ne({pageSize:B,prefix:G}),{products:c,count:h,isLoading:C,isError:m,error:S}=se(o,{placeholderData:ve}),N=d=>{const a=typeof d=="function"?d(p):d,u=Object.keys(a),v=Object.keys(j).reduce((k,H)=>(u.includes(H)&&(k[H]=j[H]),k),{}),b=u.map(k=>({id:k}));l("product_ids",b,{shouldDirty:!0,shouldTouch:!0}),l("products",v,{shouldDirty:!0,shouldTouch:!0}),f(a)},T=Me(),z=Te(),{table:r}=Le({data:c||[],columns:T,count:h,enablePagination:!0,enableRowSelection:d=>{var a;return!!((a=d.original.variants)!=null&&a.length)},getRowId:d=>d.id,rowSelection:{state:p,updater:N},pageSize:B,prefix:G});if(m)throw S;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(_e,{table:r,columns:T,filters:z,pageSize:B,prefix:G,count:h,isLoading:C,layout:"fill",orderBy:[{key:"title",label:s("fields.title")},{key:"status",label:s("fields.status")},{key:"created_at",label:s("fields.createdAt")},{key:"updated_at",label:s("fields.updatedAt")}],pagination:!0,search:!0,queryObject:x,noRecords:{message:s("priceLists.create.products.list.noRecordsMessage")}})})},Ae=ye(),Me=()=>{const i=Se();return R.useMemo(()=>[Ae.display({id:"select",header:({table:s})=>e.jsx(W,{checked:s.getIsSomePageRowsSelected()?"indeterminate":s.getIsAllPageRowsSelected(),onCheckedChange:n=>s.toggleAllPageRowsSelected(!!n)}),cell:({row:s})=>e.jsx(W,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onCheckedChange:n=>s.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}),...i],[i])};ee(K({id:I(),name:I()}));var M=K({type:q(["sale","override"]),status:q(["draft","active"]),title:I().min(1),description:I().min(1),starts_at:X().nullish(),ends_at:X().nullish(),product_ids:ee(K({id:I()})).min(1),products:oe,rules:ne.nullish()}),re=M.pick({type:!0,title:!0,description:!0,starts_at:!0,ends_at:!0,customer_group_ids:!0}),Z=Object.keys(re.shape),ie=M.pick({product_ids:!0}),U=Object.keys(ie.shape),ze=M.pick({products:!0}),He=Object.keys(ze.shape),P=["detail","product","price"],Ve={detail:"in-progress",product:"not-started",price:"not-started"},Be=({regions:i,currencies:s,pricePreferences:n})=>{const[l,g]=R.useState("detail"),[j,p]=R.useState(Ve),{t:f}=A(),{handleSuccess:o}=te(),x=Y(),c=de({defaultValues:{type:"sale",status:"active",title:"",description:"",starts_at:null,ends_at:null,product_ids:[],products:{},rules:{customer_group_id:[]}},resolver:ue(M)}),{mutateAsync:h,isPending:C}=pe(),m=c.handleSubmit(async r=>{var v;const{rules:d,products:a}=r,u=(v=d==null?void 0:d.customer_group_id)!=null&&v.length?{"customer.groups.id":d.customer_group_id.map(b=>b.id)}:void 0,L=Pe(a,i);await h({title:r.title,type:r.type,status:r.status,description:r.description,starts_at:r.starts_at?r.starts_at.toISOString():null,ends_at:r.ends_at?r.ends_at.toISOString():null,rules:u,prices:L},{onSuccess:({price_list:b})=>{$.success(f("priceLists.create.successToast",{title:b.title})),o(`../${b.id}`)},onError:b=>{$.error(b.message)}})}),S=(r,d)=>{c.clearErrors(r);const a=r.reduce((L,v)=>(L[v]=c.getValues(v),L),{}),u=d.safeParse(a);return u.success?!0:(u.error.errors.forEach(({path:L,message:v,code:b})=>{c.setError(L.join("."),{type:b,message:v})}),!1)},N=r=>{switch(r){case"detail":return Z.some(a=>c.getFieldState(a).isDirty);case"product":return U.some(a=>c.getFieldState(a).isDirty);case"price":return He.some(a=>c.getFieldState(a).isDirty)}},T=r=>{if(l===r)return;if(P.indexOf(r)<P.indexOf(l)){const a=N(l);p(u=>({...u,[l]:a?u[l]:"not-started",[r]:"in-progress"})),g(r);return}const d=P.slice(0,P.indexOf(r));for(const a of d)if(a==="detail"){if(!S(Z,re)){p(u=>({...u,[a]:"in-progress"})),g(a);return}p(u=>({...u,[a]:"completed"}))}else if(a==="product"){if(!S(U,ie)){p(u=>({...u,[a]:"in-progress"})),g(a);return}p(u=>({...u,[a]:"completed"}))}p(a=>({...a,[l]:"completed",[r]:"in-progress"})),g(r)},z=r=>{if(P.indexOf(r)+1>=P.length)return;const d=P[P.indexOf(r)+1];T(d)};return e.jsx(w.Form,{form:c,children:e.jsx(y,{dir:x,value:l,onValueChange:r=>T(r),className:"flex h-full flex-col overflow-hidden",children:e.jsxs(Fe,{onSubmit:m,className:"flex h-full flex-col",children:[e.jsx(w.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(y.List,{className:"grid w-full grid-cols-3",children:[e.jsx(y.Trigger,{status:j.detail,value:"detail",children:f("priceLists.create.tabs.details")}),e.jsx(y.Trigger,{status:j.product,value:"product",children:f("priceLists.create.tabs.products")}),e.jsx(y.Trigger,{status:j.price,value:"price",children:f("priceLists.create.tabs.prices")})]})})})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(y.Content,{className:"size-full overflow-y-auto",value:"detail",children:e.jsx(ke,{form:c})}),e.jsx(y.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(Oe,{form:c})}),e.jsx(y.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(De,{form:c,regions:i,currencies:s,pricePreferences:n})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(E,{variant:"secondary",size:"small",children:f("actions.cancel")})}),e.jsx(Ge,{tab:l,next:z,isLoading:C})]})})]})})})},Ge=({tab:i,next:s,isLoading:n})=>{const{t:l}=A();return i==="price"?e.jsx(E,{type:"submit",variant:"primary",size:"small",isLoading:n,children:l("actions.save")},"submit-button"):e.jsx(E,{type:"button",variant:"primary",size:"small",onClick:()=>s(i),children:l("actions.continue")},"next-button")},js=()=>{const{isReady:i,regions:s,currencies:n,pricePreferences:l}=le();return e.jsx(w,{children:i&&e.jsx(Be,{regions:s,currencies:n,pricePreferences:l})})};export{js as Component};
